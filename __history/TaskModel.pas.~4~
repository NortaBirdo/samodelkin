unit TaskModel;

interface

uses
  System.SysUtils, System.Classes, uADStanIntf, uADStanOption, uADStanParam,
  uADStanError, uADDatSManager, uADPhysIntf, uADDAptIntf, uADStanAsync,
  uADDAptManager, Data.DB, uADCompDataSet, uADCompClient;

type
  TTaskDataModule = class(TDataModule)
    ADQueryTask: TADQuery;
    DataSourceTask: TDataSource;
    ADQuerySQL: TADQuery;
  private
    ShowCloseTask: boolean;
  public
    procedure GetTasks;
    function GetIdTask:integer;
    function GetSalaryTask:integer;
    procedure SetProjectLink(id:integer);
    procedure SetFreelancerLink(id: integer);
    procedure SetDeadline(Dt: TDate);
    procedure RefreshTask;
    procedure SetShowCloseTask(show: boolean);
  end;

var
  TaskDataModule: TTaskDataModule;

implementation

{%CLASSGROUP 'Vcl.Controls.TControl'}

uses DataModuleMySQLUnit, ProjectModelUnit;

{$R *.dfm}

{ TTaskDataModule }

function TTaskDataModule.GetIdTask: integer;
begin
  result := DataModuleMySQL.ADQueryTask.FieldByName('id').AsInteger
end;

function TTaskDataModule.GetSalaryTask: integer;
begin
  result := DataModuleMySQL.ADQueryTask.FieldByName('salary').AsInteger
end;

procedure TTaskDataModule.GetTasks;
begin
  with ADQueryTask do
  begin
    close;
    Sql.Clear;

    if ShowCloseTask then
     Sql.Add('Select TASK.*, FREELANCER.Id, FREELANCER.fio from TASK, FREELANCER ' +
      'WHERE TASK.freelancer_link = FREELANCER.id AND TASK.project_link = ' + IntToStr(ProjectModel.GetIDProject))
    else
     Sql.Add('Select TASK.*, FREELANCER.Id, FREELANCER.fio from TASK, FREELANCER ' +
      'WHERE TASK.freelancer_link = FREELANCER.id AND TASK.project_link = ' + IntToStr(ProjectModel.GetIDProject) +
      ' AND TASK.status <> ' + QuotedStr('закрыта'));
    open;
  end;
end;

procedure TTaskDataModule.RefreshTask;
begin
  ADQueryTask.Refresh;
end;

procedure TTaskDataModule.SetDeadline(Dt: TDate);
begin
  ADQueryTask.Edit;
  ADQueryTask.FieldByName('deadline').Value := Dt;
end;

procedure TTaskDataModule.SetFreelancerLink(id: integer);
begin
  ADQueryTask.Edit;
  ADQueryTask.FieldByName('freelancer_link').Value := id;
end;

procedure TTaskDataModule.SetProjectLink(id: integer);
begin
  ADQueryTask.Edit;
  ADQueryTask.FieldByName('project_link').Value := id;
end;

//показать/скрыть закрытые таски
procedure TTaskDataModule.SetShowCloseTask(show: boolean);
begin
  ShowCloseTask := show;
end;

end.
